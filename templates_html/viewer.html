<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results Viewer - LLM Interrogation</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header>
        <h1>LLM Interrogation Dashboard</h1>
        <nav>
            <a href="/">Dashboard</a>
            <a href="/viewer" class="active">Results Viewer</a>
        </nav>
    </header>

    <main class="viewer-layout">
        <aside class="results-list">
            <h2>Results History</h2>
            <div class="results-scroll">
                {% for result in results %}
                <div class="result-item" data-filename="{{ result.filename }}" onclick="loadResult('{{ result.filename }}')">
                    <div class="result-meta">
                        <span class="result-template">{{ result.template }}</span>
                        <span class="result-runs">{{ result.runs }} runs</span>
                    </div>
                    <div class="result-info">
                        <span class="result-model">{{ result.model }}</span>
                        <span class="result-time">{{ result.timestamp }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </aside>

        <section class="result-detail">
            <div id="result-content">
                <div class="placeholder">
                    <h3>Select a result to view</h3>
                    <p>Click on a result from the list to see detailed findings and responses.</p>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>LLM Interrogation Tool - <a href="https://github.com/joelteply/llm-interrogation">GitHub</a></p>
    </footer>

    <script>
        function loadResult(filename) {
            // Highlight selected
            document.querySelectorAll('.result-item').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-filename="${filename}"]`).classList.add('selected');

            fetch(`/api/results/${filename}`)
                .then(res => res.json())
                .then(data => {
                    renderResult(data);
                })
                .catch(err => {
                    document.getElementById('result-content').innerHTML = `<div class="error">Error loading result: ${err}</div>`;
                });
        }

        function renderResult(data) {
            let html = `
                <div class="result-header">
                    <h2>${data.template}</h2>
                    <div class="result-meta-detail">
                        <span><strong>Model:</strong> ${data.model}</span>
                        <span><strong>Temperature:</strong> ${data.temperature}</span>
                        <span><strong>Runs:</strong> ${data.runs}</span>
                        <span><strong>Timestamp:</strong> ${data.timestamp}</span>
                    </div>
                </div>
            `;

            // Stats
            if (data.stats && Object.keys(data.stats).length > 0) {
                html += '<div class="stats-grid">';
                for (const [category, terms] of Object.entries(data.stats)) {
                    html += `<div class="stat-card"><h3>${category}</h3><div class="stat-terms">`;
                    const sorted = Object.entries(terms).sort((a,b) => b[1].rate - a[1].rate);
                    for (const [term, info] of sorted) {
                        const pct = Math.round(info.rate * 100);
                        const conf = pct >= 50 ? 'high' : pct >= 25 ? 'med' : 'low';
                        html += `
                            <div class="stat-row">
                                <span class="stat-term-name">${term}</span>
                                <div class="stat-bar-wrap">
                                    <div class="stat-bar ${conf}" style="width: ${pct}%"></div>
                                </div>
                                <span class="stat-pct">${pct}%</span>
                                <span class="confidence-badge ${conf}">${info.count}/${data.runs}</span>
                            </div>
                        `;
                    }
                    html += '</div></div>';
                }
                html += '</div>';
            }

            // Responses
            if (data.responses && data.responses.length > 0) {
                html += '<div class="responses-section"><h3>Raw Responses</h3>';
                data.responses.forEach((resp, i) => {
                    html += `
                        <details class="response-accordion">
                            <summary>Response ${i + 1}</summary>
                            <div class="response-content">${escapeHtml(resp)}</div>
                        </details>
                    `;
                });
                html += '</div>';
            }

            document.getElementById('result-content').innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // Load first result by default
        {% if results %}
        loadResult('{{ results[0].filename }}');
        {% endif %}
    </script>
</body>
</html>
