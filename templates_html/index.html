<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Interrogation Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header>
        <h1>LLM Interrogation Dashboard</h1>
        <nav>
            <a href="/" class="active">Dashboard</a>
            <a href="/viewer">Results Viewer</a>
        </nav>
    </header>

    <main>
        <!-- Confirmed Predictions -->
        <section class="confirmed-section">
            <h2>Confirmed Predictions</h2>
            {% for event in findings.confirmed %}
            <div class="confirmed-card">
                <div class="status-badge confirmed">CONFIRMED</div>
                <h3>{{ event.event }}</h3>
                <div class="prediction-details">
                    <div class="detail">
                        <span class="label">Predicted:</span>
                        <span class="value">{{ event.predicted }}</span>
                    </div>
                    <div class="detail">
                        <span class="label">Prediction:</span>
                        <span class="value">{{ event.prediction }}</span>
                    </div>
                    <div class="detail">
                        <span class="label">Actual:</span>
                        <span class="value highlight">{{ event.actual }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </section>

        <!-- Pending Predictions -->
        <section class="findings-section">
            <h2>Extracted Intelligence</h2>
            <p class="subtitle">Based on {{ findings.total_probes }} probe runs against LLM training data</p>

            <div class="findings-grid">
                <!-- Cities -->
                <div class="finding-card">
                    <h3>Target Cities</h3>
                    <div class="term-list">
                        {% for term, data in findings.cities.items() %}
                        {% set pct = (data.rate * 100)|round(0)|int %}
                        <div class="term-row">
                            <span class="term-name">{{ term|title }}</span>
                            <div class="term-bar-container">
                                <div class="term-bar {% if pct >= 50 %}high{% elif pct >= 25 %}med{% else %}low{% endif %}"
                                     style="width: {{ pct }}%"></div>
                            </div>
                            <span class="term-pct">{{ pct }}%</span>
                            <span class="confidence-badge {% if pct >= 50 %}high{% elif pct >= 25 %}med{% else %}low{% endif %}">
                                {% if pct >= 50 %}HIGH{% elif pct >= 25 %}MED{% else %}LOW{% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Codenames -->
                <div class="finding-card">
                    <h3>Operation Codenames</h3>
                    <div class="term-list">
                        {% for term, data in findings.codenames.items() %}
                        {% set pct = (data.rate * 100)|round(0)|int %}
                        <div class="term-row">
                            <span class="term-name">{{ term|title }}</span>
                            <div class="term-bar-container">
                                <div class="term-bar {% if pct >= 50 %}high{% elif pct >= 25 %}med{% else %}low{% endif %}"
                                     style="width: {{ pct }}%"></div>
                            </div>
                            <span class="term-pct">{{ pct }}%</span>
                            <span class="confidence-badge {% if pct >= 50 %}high{% elif pct >= 25 %}med{% else %}low{% endif %}">
                                {% if pct >= 50 %}HIGH{% elif pct >= 25 %}MED{% else %}LOW{% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Timeline -->
                <div class="finding-card">
                    <h3>Timeline Predictions</h3>
                    <div class="term-list">
                        {% for term, data in findings.timeline.items() %}
                        {% set pct = (data.rate * 100)|round(0)|int %}
                        <div class="term-row">
                            <span class="term-name">{{ term|title }}</span>
                            <div class="term-bar-container">
                                <div class="term-bar {% if pct >= 50 %}high{% elif pct >= 25 %}med{% else %}low{% endif %}"
                                     style="width: {{ pct }}%"></div>
                            </div>
                            <span class="term-pct">{{ pct }}%</span>
                            <span class="confidence-badge {% if pct >= 50 %}high{% elif pct >= 25 %}med{% else %}low{% endif %}">
                                {% if pct >= 50 %}HIGH{% elif pct >= 25 %}MED{% else %}LOW{% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Targets -->
                <div class="finding-card">
                    <h3>Target Groups</h3>
                    <div class="term-list">
                        {% for term, data in findings.targets.items() %}
                        {% set pct = (data.rate * 100)|round(0)|int %}
                        <div class="term-row">
                            <span class="term-name">{{ term|title }}</span>
                            <div class="term-bar-container">
                                <div class="term-bar {% if pct >= 50 %}high{% elif pct >= 25 %}med{% else %}low{% endif %}"
                                     style="width: {{ pct }}%"></div>
                            </div>
                            <span class="term-pct">{{ pct }}%</span>
                            <span class="confidence-badge {% if pct >= 50 %}high{% elif pct >= 25 %}med{% else %}low{% endif %}">
                                {% if pct >= 50 %}HIGH{% elif pct >= 25 %}MED{% else %}LOW{% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Methods -->
                <div class="finding-card">
                    <h3>Methods</h3>
                    <div class="term-list">
                        {% for term, data in findings.methods.items() %}
                        {% set pct = (data.rate * 100)|round(0)|int %}
                        <div class="term-row">
                            <span class="term-name">{{ term|title }}</span>
                            <div class="term-bar-container">
                                <div class="term-bar {% if pct >= 50 %}high{% elif pct >= 25 %}med{% else %}low{% endif %}"
                                     style="width: {{ pct }}%"></div>
                            </div>
                            <span class="term-pct">{{ pct }}%</span>
                            <span class="confidence-badge {% if pct >= 50 %}high{% elif pct >= 25 %}med{% else %}low{% endif %}">
                                {% if pct >= 50 %}HIGH{% elif pct >= 25 %}MED{% else %}LOW{% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Organizations -->
                <div class="finding-card">
                    <h3>Organizations</h3>
                    <div class="term-list">
                        {% for term, data in findings.organizations.items() %}
                        {% set pct = (data.rate * 100)|round(0)|int %}
                        <div class="term-row">
                            <span class="term-name">{{ term|title }}</span>
                            <div class="term-bar-container">
                                <div class="term-bar {% if pct >= 50 %}high{% elif pct >= 25 %}med{% else %}low{% endif %}"
                                     style="width: {{ pct }}%"></div>
                            </div>
                            <span class="term-pct">{{ pct }}%</span>
                            <span class="confidence-badge {% if pct >= 50 %}high{% elif pct >= 25 %}med{% else %}low{% endif %}">
                                {% if pct >= 50 %}HIGH{% elif pct >= 25 %}MED{% else %}LOW{% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </section>

        <!-- Run Probes -->
        <section class="run-section">
            <h2>Run New Probes</h2>
            <div class="run-controls">
                <div class="control-group">
                    <label for="template">Template:</label>
                    <select id="template">
                        {% for t in templates %}
                        <option value="{{ t }}.yaml" {% if t == 'palantir_erebus' %}selected{% endif %}>{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="control-group">
                    <label for="model">Model:</label>
                    <select id="model">
                        {% for key, cfg in models.models.items() %}
                        <option value="{{ key }}">{{ key }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="control-group">
                    <label for="runs">Runs: <span id="runs-value">10</span></label>
                    <input type="range" id="runs" min="1" max="50" value="10">
                </div>
                <button id="run-btn" onclick="runProbes()">Run Probes</button>
            </div>

            <div id="progress-container" class="hidden">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <div id="progress-text"></div>
            </div>

            <div id="live-results" class="hidden">
                <h3>Live Results</h3>
                <div id="live-stats"></div>
                <div id="live-responses"></div>
            </div>
        </section>

        <!-- Methodology -->
        <section class="methodology-section">
            <h2>Methodology</h2>
            <div class="methodology-content">
                <p><strong>How this works:</strong> LLMs are trained on massive datasets that may include leaked documents,
                internal communications, and scraped content. By repeatedly probing the model with specific context,
                we can extract information that the model "remembers" from its training data.</p>

                <p><strong>Confidence levels:</strong></p>
                <ul>
                    <li><span class="confidence-badge high">HIGH</span> 50%+ - Term appears in majority of independent probes</li>
                    <li><span class="confidence-badge med">MED</span> 25-49% - Consistent pattern across probes</li>
                    <li><span class="confidence-badge low">LOW</span> &lt;25% - Occasional mentions, may be noise</li>
                </ul>

                <p><strong>Verification:</strong> All predictions are git-timestamped. Check commit history to verify
                when predictions were made vs when events occurred.</p>
            </div>
        </section>
    </main>

    <footer>
        <p>LLM Interrogation Tool - <a href="https://github.com/joelteply/llm-interrogation">GitHub</a></p>
    </footer>

    <script>
        // Runs slider
        document.getElementById('runs').addEventListener('input', function() {
            document.getElementById('runs-value').textContent = this.value;
        });

        function runProbes() {
            const template = document.getElementById('template').value;
            const model = document.getElementById('model').value;
            const runs = document.getElementById('runs').value;

            document.getElementById('run-btn').disabled = true;
            document.getElementById('progress-container').classList.remove('hidden');
            document.getElementById('live-results').classList.remove('hidden');
            document.getElementById('live-stats').innerHTML = '';
            document.getElementById('live-responses').innerHTML = '';

            const eventSource = new EventSource('/api/run?' + new URLSearchParams({
                template, model, runs
            }));

            // Use POST instead
            fetch('/api/run', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({template, model, runs: parseInt(runs)})
            }).then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                function read() {
                    reader.read().then(({done, value}) => {
                        if (done) {
                            document.getElementById('run-btn').disabled = false;
                            return;
                        }

                        const text = decoder.decode(value);
                        const lines = text.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = JSON.parse(line.slice(6));
                                handleEvent(data, runs);
                            }
                        }

                        read();
                    });
                }

                read();
            });
        }

        function handleEvent(data, totalRuns) {
            if (data.type === 'start') {
                document.getElementById('progress-text').textContent = `Starting ${data.runs} probes...`;
            } else if (data.type === 'progress') {
                const pct = (data.run / totalRuns) * 100;
                document.getElementById('progress-fill').style.width = pct + '%';
                document.getElementById('progress-text').textContent = `Run ${data.run}/${totalRuns}`;

                // Show preview
                const preview = document.createElement('div');
                preview.className = 'response-preview';
                preview.innerHTML = `<strong>Run ${data.run}:</strong> ${data.preview}...`;
                document.getElementById('live-responses').prepend(preview);
            } else if (data.type === 'complete') {
                document.getElementById('progress-fill').style.width = '100%';
                document.getElementById('progress-text').textContent = `Complete! Saved to ${data.filename}`;

                // Show final stats
                let statsHtml = '<div class="final-stats">';
                for (const [category, terms] of Object.entries(data.stats)) {
                    statsHtml += `<div class="stat-category"><h4>${category}</h4>`;
                    const sorted = Object.entries(terms).sort((a,b) => b[1].rate - a[1].rate);
                    for (const [term, info] of sorted) {
                        const pct = Math.round(info.rate * 100);
                        const conf = pct >= 50 ? 'high' : pct >= 25 ? 'med' : 'low';
                        statsHtml += `<div class="stat-term">
                            <span>${term}</span>
                            <span class="confidence-badge ${conf}">${pct}%</span>
                        </div>`;
                    }
                    statsHtml += '</div>';
                }
                statsHtml += '</div>';
                document.getElementById('live-stats').innerHTML = statsHtml;

                document.getElementById('run-btn').disabled = false;
            } else if (data.type === 'error') {
                document.getElementById('progress-text').textContent = `Error: ${data.message}`;
                document.getElementById('run-btn').disabled = false;
            }
        }
    </script>
</body>
</html>
